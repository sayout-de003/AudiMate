{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Audit Report - {{ audit.id }}</title>
    <!-- Google Fonts: Inter / Roboto -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        @page {
            size: A4;
            margin: 2cm;

            @top-right {
                content: "Confidential Security Audit";
                font-family: 'Inter', sans-serif;
                font-size: 8pt;
                color: #888;
            }

            @bottom-center {
                content: "Page " counter(page);
                font-family: 'Inter', sans-serif;
                font-size: 8pt;
                color: #888;
            }
        }

        /* Force Visibility for PDF/Print */
        @media print {

            .system-logs,
            .affected-resources,
            .detailed-findings,
            .evidence-container {
                display: block !important;
                visibility: visible !important;
                height: auto !important;
                overflow: visible !important;
            }

            pre,
            code {
                white-space: pre-wrap !important;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            font-size: 10pt;
            color: #374151;
            /* Slate Grey */
            line-height: 1.5;
        }

        /* Typography */
        h1,
        h2,
        h3 {
            color: #0A192F;
            /* Dark Navy */
            font-weight: 700;
        }

        h1 {
            font-size: 24pt;
            border-bottom: 2px solid #0A192F;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 16pt;
            margin-top: 30px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 5px;
        }

        h3 {
            font-size: 12pt;
            margin: 0;
        }

        /* Colors */
        .text-critical {
            color: #D32F2F;
        }

        .text-high {
            color: #E65100;
        }

        .text-medium {
            color: #F57C00;
        }

        .text-pass {
            color: #1B5E20;
        }

        /* Layout */
        .section-break {
            page-break-before: always;
        }

        .no-break {
            page-break-inside: avoid;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            margin-top: 10px;
        }

        th,
        td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background-color: #f8fafc;
            color: #1a202c;
            font-weight: 600;
        }

        /* Finding Block */
        .finding-block {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0;
            margin-bottom: 20px;
            background: #fff;
            page-break-inside: avoid;
        }

        .finding-header {
            background-color: #f8fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .finding-body {
            padding: 16px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 8pt;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-FAIL {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .badge-PASS {
            background-color: #dcfce7;
            color: #15803d;
        }

        .badge-CRITICAL {
            background-color: #fca5a5;
            color: #7f1d1d;
        }

        /* Evidence Box */
        .evidence-container {
            margin-top: 15px;
            background: #f9fafb;
            border: 1px dashed #e5e7eb;
            padding: 10px;
            border-radius: 4px;
            page-break-inside: avoid;
        }

        .evidence-img {
            max-width: 100%;
            border: 1px solid #e5e7eb;
            margin-top: 8px;
        }

        /* Technical Log CSS */
        .code-block {
            font-family: 'Roboto Mono', 'Courier New', monospace;
            background-color: #1e293b;
            /* Dark bg for contrast */
            color: #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            font-size: 8pt;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 8px;
            page-break-inside: avoid;
        }

        .code-header {
            font-size: 8pt;
            font-weight: 600;
            color: #64748b;
            margin-top: 8px;
        }

        .json-logs {
            font-family: 'Courier New', monospace;
            background: #f4f4f4;
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 8pt;
            white-space: pre-wrap;
            /* Wrap long lines */
            word-break: break-all;
            margin-top: 10px;
            color: #333;
            page-break-inside: avoid;
        }

        .log-label {
            font-size: 8pt;
            font-weight: bold;
            color: #555;
            margin-top: 5px;
        }

        /* Cover Page */
        .cover-page {
            text-align: center;
            padding-top: 30%;
        }

        .cover-title {
            font-size: 32pt;
            font-weight: 700;
            color: #0A192F;
            letter-spacing: -0.02em;
        }
    </style>
</head>

<body>

    <!-- Cover Page -->
    <div class="cover-page section-break">
        <div class="cover-title">SECURITY AUDIT REPORT</div>
        <div style="font-size: 14pt; margin-top: 20px; color: #64748b;">
            Prepared for {{ audit.organization.name }}
        </div>
        <div style="margin-top: 60px;">
            <div
                style="font-size: 64pt; font-weight: 800; color: {% if stats.pass_rate_percentage >= 80 %}#1B5E20{% else %}#D32F2F{% endif %};">
                {{ stats.pass_rate_percentage|floatformat:0 }}%
            </div>
            <div style="font-size: 12pt; text-transform: uppercase; letter-spacing: 2px;">Compliance Score</div>
        </div>
        <div style="margin-top: 100px; font-size: 10pt; color: #888;">
            Audit ID: {{ audit.id }}<br>
            Generated: {{ generated_at }}
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="section-break">
        <h1>Executive Summary</h1>
        <p>This report provides a detailed analysis of the security posture of <strong>{{ audit.organization.name
                }}</strong> based on the audit performed on {{ audit.created_at|date:"F j, Y" }}.</p>

        <table style="margin-top: 20px; border: 1px solid #e2e8f0;">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Count</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Total Checks</td>
                    <td>{{ stats.total_findings }}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Passed Checks</td>
                    <td>{{ stats.passed_count }}</td>
                    <td><span class="badge badge-PASS">OK</span></td>
                </tr>
                <tr>
                    <td>Failed Checks</td>
                    <td>{{ stats.failed_count }}</td>
                    <td>
                        {% if stats.failed_count > 0 %}
                        <span class="badge badge-FAIL">ATTENTION</span>
                        {% else %}
                        <span class="badge badge-PASS">CLEAN</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Detailed Findings -->
    <div class="section-break">
        <h1>Detailed Findings</h1>
        <p style="margin-bottom: 20px; color: #666; font-size: 9pt;">
            The following section details the compliance checks performed.
            Prioritize addressing <strong>CRITICAL</strong> and <strong>HIGH</strong> severity issues.
        </p>

        {% for check in checks %}
        <div class="finding-block no-break">
            <div class="finding-header">
                <div>
                    <h3>{{ check.rule_id }}: {{ check.title }}</h3>
                </div>
                <div>
                    {% if check.status == 'FAIL' %}
                    <span class="badge badge-FAIL">FAIL</span>
                    {% else %}
                    <span class="badge badge-PASS">PASS</span>
                    {% endif %}
                    <span class="badge" style="background: #f3f4f6; color: #374151; margin-left: 5px;">
                        {{ check.severity }}</span>
                </div>
            </div>

            <div class="finding-body">
                <p>{{ check.description }}</p>

                {% if check.status == 'FAIL' %}
                <!-- Master Finding Logic (Table of affected repos) -->
                <div class="mt-4">
                    <strong>Affected Resources:</strong>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%">Resource</th>
                                <th>Issue / Remediation</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for finding in check.findings %}
                            {% if finding.status == 'FAIL' %}
                            <tr>
                                <td style="vertical-align: top;"><strong>{{ finding.resource }}</strong></td>
                                <td style="vertical-align: top;">
                                    {{ finding.comment|default:"No details provided." }}
                                    {% if finding.remediation %}
                                    <div style="margin-top:5px; font-weight:bold; color: #555;">Remediation:</div>
                                    <div style="background:#eee; padding:5px; border-radius:3px;">{{ finding.remediation
                                        }}</div>
                                    {% endif %}

                                    <!-- Technical Evidence Block inside the table row or below? -->
                                    <!-- Keeping it concise in table, detailed evidence below if needed. Using inline format here per request -->
                                    <div class="evidence-container">
                                        {% if finding.screenshot %}
                                        <div class="log-label">Screenshot:</div>
                                        <img src="file://{{ finding.screenshot.path }}" class="evidence-img">
                                        {% elif finding.json_log %}
                                        <div class="log-label">System Logs:</div>
                                        <pre class="json-logs">{{ finding.json_log }}</pre>
                                        {% else %}
                                        <div style="font-style: italic; color: #888; font-size: 8pt; margin-top: 5px;">
                                            No visual evidence or logs captured.
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <!-- Passing checks summary -->
                <div style="margin-top: 10px; font-size: 9pt; color: #1B5E20;">
                    âœ“ Compliance met across {{ check.passed_count }} resource(s).
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

</body>

</html>